<!DOCTYPE html>
<html>

<head>
    <title>Leaflet Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        html,
        body {
            padding: 0;
            margin: 0;
            height: 100%;
        }

        #lmap {
            height: 100%;
        }

        #arrow-container {
            z-index: 1001;
        }
    </style>
</head>

<body>
    <div id="lmap"></div>
    <div id="arrow-container"></div>
    <div class="absolute">
        <button id="tempButton" onclick="toggleTempMap()">顯示溫度</button>
        <button id="rainButton" onclick="toggleRainMap()">显示雨量</button>
        <button id="d3Button" onclick="toggleD3()">D3</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/heatmap.js/build/heatmap.min.js"></script>
    <script src="https://unpkg.com/heatmap.js/plugins/leaflet-heatmap/leaflet-heatmap.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        // 下載地圖
        const LMap = L.map(document.getElementById('lmap'), {
            center: [23.5, 121],
            zoom: 10,
            crs: L.CRS.EPSG3857,
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            id: 'mapbox.streets'
        }).addTo(LMap);

        // 下載氣候數據
        let temperatureData = []
        fetch('weather.json')
            .then(response => response.json())
            .then(data => {
                const locations = data.records.location;

                temperatureData = locations.map(location => {
                    const lat = parseFloat(location.lat);
                    const lon = parseFloat(location.lon);
                    const temperature = parseFloat(location.weatherElement.find(element => element.elementName === 'TEMP').elementValue);
                    const wdir = parseFloat(location.weatherElement.find(element => element.elementName === 'WDIR').elementValue);
                    const wdsd = parseFloat(location.weatherElement.find(element => element.elementName === 'WDSD').elementValue);
                    const pres = parseFloat(location.weatherElement.find(element => element.elementName === 'PRES').elementValue);
                    const precipitation = parseFloat(location.weatherElement.find(element => element.elementName === 'H_24R').elementValue);
                    return { lat, lon, temperature, wdir, wdsd, pres, precipitation };
                });
            })
            .catch(error => {
                console.error('Error loading JSON:', error);
            });

        // 下載降雨量數據
        let arr = [];
        fetch('precipitation.json')
            .then(response => response.json())
            .then(data => {
                // 建立新陣列
                arr = data.records.location.map(location => {
                    return {
                        lat: parseFloat(location.lat),
                        lon: parseFloat(location.lon),
                        value: parseFloat(location.weatherElement.find(element => element.elementName === 'RAIN').elementValue)
                    };
                });
            })
            .catch(error => {
                console.error('Error loading JSON:', error);
            });

        let marker = null
        let heatmapLayer = null
        let temperatureMarkers = [];
        let svgContainer = null

        function toggleD3() {
            clear()
            // 创建 SVG 容器
            svgContainer = d3.select(LMap.getPanes().overlayPane)
                .append('svg')
                .attr('class', 'arrow-container')
                .attr('width', LMap.getSize().x)
                .attr('height', LMap.getSize().y);

            // 创建箭头和线段
            const arrows = svgContainer.selectAll('.arrow')
                .data(temperatureData)
                .enter()
                .append('g')
                .attr('class', 'arrow');

            arrows.append('path')
                .attr('d', 'M0,-5L10,0L0,5')
                .attr('stroke', 'red')
                .attr('fill', 'red')
                .attr('stroke-width', d => d.wdsd); // 使用 size 属性控制箭头的大小

            arrows.append('line')
                .attr('x1', 0)
                .attr('y1', 0)
                .attr('x2', -20) // 线段长度
                .attr('y2', 0)
                .attr('stroke', 'red')
                .attr('stroke-width', d => d.wdsd); // 使用 size 属性控制线段的大小

            // 更新箭头位置和旋转角度
            function updateArrows() {
                arrows.attr('transform', d => {
                    const latLng = L.latLng(d.lat, d.lon);
                    const point = LMap.latLngToLayerPoint(latLng);
                    const x = point.x;
                    const y = point.y;
                    return `translate(${x},${y}) rotate(${d.wdir})`;
                });
            }

            // 初始化箭头位置
            updateArrows();

            // 监听地图缩放事件，更新箭头位置
            LMap.on('zoomend', updateArrows);
        }

        function toggleTempMap() {
            clear()
            temperatureData.forEach(dataPoint => {
                marker = L.circleMarker([dataPoint.lat, dataPoint.lon], {
                    radius: 5,
                    color: 'red',
                    fillColor: 'red',
                    fillOpacity: 0.8
                }).addTo(LMap);

                // 添加气温信息的弹出窗口
                marker.bindPopup(`Temperature: ${dataPoint.temperature} °C`);
                temperatureMarkers.push(marker);
            });
        }

        // 顯示降雨量
        function toggleRainMap() {
            clear()
            const option = {
                "scaleRadius": false,
                "radius": 50,
                "useLocalExtrema": true,
                latField: 'lat',
                lngField: 'lon',
                valueField: 'value',
                "maxOpacity": .5
            };
            heatmapLayer = new HeatmapOverlay(option);
            const testData = {
                max: 100,
                data: arr
            };
            heatmapLayer.setData(testData);
            heatmapLayer.addTo(LMap);
        }

        // 清除之前圖層
        function clear() {
            if (heatmapLayer) {
                LMap.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
            if (temperatureMarkers) {
                temperatureMarkers.forEach(marker => {
                    LMap.removeLayer(marker);
                });
                temperatureMarkers = [];
            }
            if (svgContainer) {
                svgContainer.remove();
                svgContainer = null;
            }
        }

    </script>

</body>

</html>

<style>
    .absolute {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>