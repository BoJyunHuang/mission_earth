<!DOCTYPE html>
<html>

<head>
    <title>Leaflet Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        html,
        body {
            padding: 0;
            margin: 0;
            height: 100%;
        }

        #lmap {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="lmap"></div>
    <div class="absolute">
        <button id="windButton" onclick="toggleWindMap()">显示风向</button>
        <button id="rainButton" onclick="toggleRainMap()">显示雨量</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/heatmap.js/build/heatmap.min.js"></script>
    <script src="https://unpkg.com/heatmap.js/plugins/leaflet-heatmap/leaflet-heatmap.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
        // 下載地圖
        const LMap = L.map(document.getElementById('lmap'), {
            center: [23.5, 121],
            zoom: 10,
            crs: L.CRS.EPSG3857,
        });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            id: 'mapbox.streets'
        }).addTo(LMap);

        // 下載氣候數據
        let temperatureData = []
        fetch('weather.json')
            .then(response => response.json())
            .then(data => {
                const locations = data.records.location;

                temperatureData = locations.map(location => {
                    const lat = parseFloat(location.lat);
                    const lon = parseFloat(location.lon);
                    const temperature = parseFloat(location.weatherElement.find(element => element.elementName === 'TEMP').elementValue);

                    return { lat, lon, temperature };
                });
            })
            .catch(error => {
                console.error('Error loading JSON:', error);
            });

        // 下載降雨量數據
        let arr = [];
        fetch('precipitation.json')
            .then(response => response.json())
            .then(data => {
                // 建立新陣列
                arr = data.records.location.map(location => {
                    return {
                        lat: parseFloat(location.lat),
                        lon: parseFloat(location.lon),
                        value: parseFloat(location.weatherElement.find(element => element.elementName === 'RAIN').elementValue)
                    };
                });
            })
            .catch(error => {
                console.error('Error loading JSON:', error);
            });

        let marker = null
        let heatmapLayer = null
        let temperatureMarkers = [];
        function toggleWindMap() {
            if (heatmapLayer) {
                LMap.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
            if (temperatureMarkers) {
                temperatureMarkers.forEach(marker => {
                    LMap.removeLayer(marker);
                });
                temperatureMarkers = [];
            }
            temperatureData.forEach(dataPoint => {
                marker = L.circleMarker([dataPoint.lat, dataPoint.lon], {
                    radius: 5,
                    color: 'red',
                    fillColor: 'red',
                    fillOpacity: 0.8
                }).addTo(LMap);

                // 添加气温信息的弹出窗口
                marker.bindPopup(`Temperature: ${dataPoint.temperature} °C`);
                temperatureMarkers.push(marker);
            });
        }

        // 顯示降雨量
        function toggleRainMap() {
            if (heatmapLayer) {
                LMap.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }
            if (temperatureMarkers) {
                temperatureMarkers.forEach(marker => {
                    LMap.removeLayer(marker);
                });
                temperatureMarkers = [];
            }
            const option = {
                "scaleRadius": false,
                "radius": 50,
                "useLocalExtrema": true,
                latField: 'lat',
                lngField: 'lon',
                valueField: 'value',
                "maxOpacity": .5
            };
            heatmapLayer = new HeatmapOverlay(option);
            const testData = {
                max: 100,
                data: arr
            };
            heatmapLayer.setData(testData);
            heatmapLayer.addTo(LMap);
        }

        const windButton = document.getElementById('windButton');
        const rainButton = document.getElementById('rainButton');

        windButton.addEventListener('click', toggleWindMap);
        rainButton.addEventListener('click', toggleRainMap);
    </script>

</body>

</html>

<style>
    .absolute {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
</style>